name: Build and Release APK

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: "ç‰ˆæœ¬åç§° (ä¾‹å¦‚: 1.0.0)"
        required: false
        default: ""
      version_code:
        description: "ç‰ˆæœ¬å· (æ•´æ•°ï¼Œä¾‹å¦‚: 1)"
        required: false
        default: ""
      clean_history:
        description: "æ¸…ç†æ—§ç‰ˆæœ¬å‘å¸ƒè®°å½• (ä¿ç•™æœ€æ–°)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write  # åˆ›å»º Release å’Œç®¡ç† Tag æ‰€éœ€

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: "17"
        distribution: "temurin"

    - name: è®¾ç½® Android SDK
      uses: android-actions/setup-android@v3

    - name: è®¾ç½® Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: "8.2.1"

    - name: å®‰è£… Android å¹³å°å’Œæž„å»ºå·¥å…·
      run: |
        yes | sdkmanager "platforms;android-34" "build-tools;34.0.0"

    - name: éªŒè¯è¾“å…¥å‚æ•°
      run: |
        set -euo pipefail
        
        VERSION_NAME="${{ github.event.inputs.version_name }}"
        VERSION_CODE="${{ github.event.inputs.version_code }}"
        
        # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
        if [ -n "${VERSION_CODE}" ]; then
          if ! [[ "${VERSION_CODE}" =~ ^[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯: version_code å¿…é¡»æ˜¯æ­£æ•´æ•°"
            exit 1
          fi
          if [ "${VERSION_CODE}" -lt 1 ]; then
            echo "âŒ é”™è¯¯: version_code å¿…é¡»å¤§äºŽ 0"
            exit 1
          fi
        fi
        
        # éªŒè¯ç‰ˆæœ¬åç§°æ ¼å¼ (å…è®¸è¯­ä¹‰åŒ–ç‰ˆæœ¬)
        if [ -n "${VERSION_NAME}" ]; then
          if ! [[ "${VERSION_NAME}" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "âš ï¸  è­¦å‘Š: version_name æ ¼å¼å»ºè®®éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬ (ä¾‹å¦‚: 1.0.0)"
          fi
        fi
        
        echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

    - name: åº”ç”¨ç‰ˆæœ¬è¦†ç›–
      run: |
        set -euo pipefail
        
        VERSION_NAME="${{ github.event.inputs.version_name }}"
        VERSION_CODE="${{ github.event.inputs.version_code }}"
        
        # å¦‚æžœæä¾›äº†ç‰ˆæœ¬å‚æ•°ï¼Œä¿®æ”¹ build.gradle
        if [ -n "${VERSION_NAME}" ] || [ -n "${VERSION_CODE}" ]; then
          echo "ðŸ”§ åº”ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬ä¿¡æ¯..."
          
          if [ -n "${VERSION_CODE}" ]; then
            sed -i "s/versionCode [0-9]*/versionCode ${VERSION_CODE}/" app/build.gradle
            echo "  âœ“ versionCode = ${VERSION_CODE}"
          fi
          
          if [ -n "${VERSION_NAME}" ]; then
            sed -i "s/versionName '[^']*'/versionName '${VERSION_NAME}'/" app/build.gradle
            echo "  âœ“ versionName = ${VERSION_NAME}"
          fi
          
          echo "ä¿®æ”¹åŽçš„ç‰ˆæœ¬ä¿¡æ¯:"
          grep -E "versionCode|versionName" app/build.gradle
        else
          echo "â„¹ï¸  ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ä¿¡æ¯"
        fi

    - name: æ¸…ç†æž„å»ºç¼“å­˜
      run: |
        echo "ðŸ§¹ æ¸…ç†æ—§æž„å»ºäº§ç‰©..."
        gradle clean
        echo "âœ… æž„å»ºçŽ¯å¢ƒå·²æ¸…ç†"

    - name: æž„å»º Debug APK
      run: |
        echo "ðŸ”¨ å¼€å§‹æž„å»º Debug APK..."
        gradle assembleDebug --stacktrace
        echo "âœ… Debug APK æž„å»ºå®Œæˆ"

    - name: æ£€æŸ¥ Release ç­¾åå‡­è¯
      id: signing_check
      run: |
        set -euo pipefail

        # åˆ¤æ–·æ¢ä»¶ï¼šå¦‚æžœæœ‰ä¼ å…¥ keystore çš„ secretï¼ˆä¾‹å¦‚ KEYSTORE_BASE64ï¼‰æˆ–ä»“åº“å†…å­˜åœ¨ keystore æ–‡ä»¶ï¼Œåˆ™å¼€å¯ release æž„å»º
        if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ] || [ -f "app/libs/Modern_Xposed_API-29.aar" ] || [ -f "app/keystore.jks" ]; then
          echo "signing=true" >> $GITHUB_OUTPUT
          echo "âœ… Release signing assets available"
        else
          echo "signing=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Release signing assets not found; release build will be skipped"
        fi

    - name: æž„å»º Release APK
      if: ${{ steps.signing_check.outputs.signing == 'true' }}
      run: |
        echo "ðŸ”¨ å¼€å§‹æž„å»º Release APK..."
        gradle assembleRelease --stacktrace
        echo "âœ… Release APK æž„å»ºå®Œæˆ"

    - name: é‡å‘½å APK æ–‡ä»¶
      id: rename
      run: |
        set -euo pipefail

        # ä»Ž build.gradle è¯»å–å®žé™…ç‰ˆæœ¬
        ACTUAL_VERSION_NAME=$(grep "versionName" app/build.gradle | sed -E "s/.*versionName[[:space:]]*'([^']*)'.*/\1/")
        ACTUAL_VERSION_CODE=$(grep "versionCode" app/build.gradle | sed -E "s/.*versionCode[[:space:]]*([0-9]+).*/\1/")

        echo "å®žé™…ç‰ˆæœ¬: ${ACTUAL_VERSION_NAME} (${ACTUAL_VERSION_CODE})"

        # ç”Ÿæˆæ–‡ä»¶å
        DEBUG_APK_NAME="PowerKeyRules-v${ACTUAL_VERSION_NAME}-debug.apk"
        RELEASE_APK_NAME="PowerKeyRules-v${ACTUAL_VERSION_NAME}-release.apk"

        # é‡å‘½å/å¤åˆ¶ Debug APKï¼ˆå¿…é¡»å­˜åœ¨ï¼‰
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          cp app/build/outputs/apk/debug/app-debug.apk "${DEBUG_APK_NAME}"
          echo "DEBUG_APK_NAME=${DEBUG_APK_NAME}" >> $GITHUB_ENV
        else
          echo "Error: debug apk not found" >&2
          exit 1
        fi

        # å¦‚æžœ steps.signing_check æŒ‡ç¤ºç­¾åå¯ç”¨å¹¶ä¸” release APK å­˜åœ¨ï¼Œåˆ™å¤åˆ¶ release APK
        if [ "${{ steps.signing_check.outputs.signing }}" = "true" ] && [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          cp app/build/outputs/apk/release/app-release.apk "${RELEASE_APK_NAME}"
          echo "RELEASE_APK_NAME=${RELEASE_APK_NAME}" >> $GITHUB_ENV
          echo "release_present=true" >> $GITHUB_OUTPUT
        else
          echo "RELEASE_APK_NAME=" >> $GITHUB_ENV
          echo "release_present=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Release APK æœªç”Ÿæˆæˆ–ç­¾åä¸å¯ç”¨ï¼Œå·²è·³è¿‡å¤åˆ¶ release APK"
        fi

        # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
        echo "VERSION_NAME=${ACTUAL_VERSION_NAME}" >> $GITHUB_ENV
        echo "VERSION_CODE=${ACTUAL_VERSION_CODE}" >> $GITHUB_ENV

        echo "ðŸ“¦ APK æ–‡ä»¶å·²å¤„ç†:"
        echo "  - ${DEBUG_APK_NAME}"
        if [ "${{ steps.signing_check.outputs.signing }}" = "true" ]; then
          echo "  - ${RELEASE_APK_NAME} (å¦‚æžœå­˜åœ¨)"
        fi

    - name: ç”Ÿæˆæ–‡ä»¶æ ¡éªŒå’Œ
      run: |
        echo "ðŸ” ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ..."
        # Debug APK å¿…å®šå­˜åœ¨
        sha256sum "${DEBUG_APK_NAME}" > "${DEBUG_APK_NAME}.sha256"
        echo "Debug APK SHA256:"
        cat "${DEBUG_APK_NAME}.sha256"
        echo ""
        # ä»…å½“ release_present ä¸º true æ—¶ç”Ÿæˆ release æ ¡éªŒ
        if [ "${{ steps.rename.outputs.release_present }}" = "true" ]; then
          sha256sum "${RELEASE_APK_NAME}" > "${RELEASE_APK_NAME}.sha256"
          echo "Release APK SHA256:"
          cat "${RELEASE_APK_NAME}.sha256"
        else
          echo "âš ï¸ Release APK æœªç”Ÿæˆï¼Œè·³è¿‡ Release SHA256 ç”Ÿæˆ"
        fi

    - name: æ¸…ç†æ—§ç‰ˆæœ¬å‘å¸ƒ
      if: ${{ github.event.inputs.clean_history == 'true' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        echo "ðŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬å‘å¸ƒå’Œæ ‡ç­¾..."
        
        # åˆ é™¤æ‰€æœ‰ Release
        gh release list --limit 100 --json tagName --jq '.[].tagName' | while read -r tag; do
          echo "åˆ é™¤ Release: $tag"
          gh release delete "$tag" --yes --cleanup-tag || echo "æ— æ³•åˆ é™¤ Release $tag"
        done
        
        # åˆ é™¤æ‰€æœ‰ Tag
        git tag -l | while read -r tag; do
          echo "åˆ é™¤ Tag: $tag"
          git push origin --delete "$tag" || echo "æ— æ³•åˆ é™¤è¿œç¨‹ Tag $tag"
          git tag -d "$tag" || echo "æ— æ³•åˆ é™¤æœ¬åœ° Tag $tag"
        done
        
        echo "âœ… åŽ†å²è®°å½•æ¸…ç†å®Œæˆ"

    - name: ç”Ÿæˆ Release æ ‡ç­¾
      id: tag
      run: |
        VERSION_NAME="${{ env.VERSION_NAME }}"
        
        # ç”Ÿæˆæ—¶é—´æˆ³æ ‡ç­¾
        TAG="v${VERSION_NAME}-$(date +'%Y%m%d-%H%M%S')"
        
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "ðŸ“Œ Release æ ‡ç­¾: ${TAG}"

    - name: åˆ›å»º Release è¯´æ˜Ž
      run: |
        VERSION_NAME="${{ env.VERSION_NAME }}"
        VERSION_CODE="${{ env.VERSION_CODE }}"
        DEBUG_APK_NAME="${{ env.DEBUG_APK_NAME }}"
        RELEASE_APK_NAME="${{ env.RELEASE_APK_NAME }}"
        
        cat > release_notes.md <<EOF
        ## PowerKeyRules - å®žä½“æŒ‰é”®è§„åˆ™å¼•æ“Ž
        
        **ç‰ˆæœ¬**: ${VERSION_NAME} (Build ${VERSION_CODE})  
        **æž„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')
        
        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        | æ–‡ä»¶ | è¯´æ˜Ž | ç”¨é€” |
        |------|------|------|
        | \`${RELEASE_APK_NAME}\` | **æ­£å¼ç‰ˆæœ¬** (æŽ¨è) | æ—¥å¸¸ä½¿ç”¨ |
        | \`${DEBUG_APK_NAME}\` | è°ƒè¯•ç‰ˆæœ¬ | å¼€å‘è°ƒè¯• |
        
        ### ðŸ” æ–‡ä»¶æ ¡éªŒ
        
        **Release APK SHA256:**
        \`\`\`
        $(sha256sum "${RELEASE_APK_NAME}" | cut -d' ' -f1)
        \`\`\`
        
        **Debug APK SHA256:**
        \`\`\`
        $(sha256sum "${DEBUG_APK_NAME}" | cut -d' ' -f1)
        \`\`\`
        
        ### ðŸ“‹ å‰ç½®éœ€æ±‚
        
        - **Root çŽ¯å¢ƒ**: Magisk æˆ– KernelSU
        - **Xposed æ¡†æž¶**: LSPosed æˆ– LSPosed_mod
          - LSPosed: [GitHub ä¸‹è½½](https://github.com/LSPosed/LSPosed/releases)
          - LSPosed_mod: [GitHub ä¸‹è½½](https://github.com/mywalkb/LSPosed_mod/releases)
        
        ### ðŸ“± å®‰è£…æ­¥éª¤
        
        1. ç¡®ä¿å·²å®‰è£…å¹¶æ¿€æ´» LSPosed æ¡†æž¶
        2. ä¸‹è½½ \`${RELEASE_APK_NAME}\`
        3. å®‰è£… APK åˆ°è®¾å¤‡
        4. åœ¨ LSPosed Manager ä¸­:
           - å¯ç”¨ **PowerKeyRules** æ¨¡å—
           - å‹¾é€‰ä½œç”¨åŸŸ: **ç³»ç»Ÿæ¡†æž¶ (android)**
        5. é‡å¯è®¾å¤‡ä½¿æ¨¡å—ç”Ÿæ•ˆ
        
        ### âš™ï¸ é…ç½®æ–¹æ³•
        
        æ¨¡å—é‡‡ç”¨ **APK å†…ç½® WebUI** + **AIDL Service** æž¶æž„ã€‚
        
        1. æ‰“å¼€ APP ç‚¹å‡» "æ‰“å¼€ WebUI é…ç½®"
        2. åœ¨ Web ç•Œé¢æ·»åŠ /ä¿®æ”¹è§„åˆ™
        3. ç‚¹å‡»ä¿å­˜å³æ—¶ç”Ÿæ•ˆ
        
        *ä¸å†æ”¯æŒ XSharedPreferences æˆ– /data/adb ä¸‹çš„é…ç½®æ–‡ä»¶ã€‚*
        
        è¯¦ç»†é…ç½®è¯´æ˜Žè¯·å‚è€ƒ: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        
        ### âœ¨ ä¸»è¦ç‰¹æ€§
        
        - ðŸŽ¯ æ”¯æŒç”µæºé”®/éŸ³é‡é”®ç­‰å®žä½“æŒ‰é”®æ˜ å°„
        - ðŸ“ æ”¯æŒçŸ­æŒ‰ã€é•¿æŒ‰ã€åŒå‡»ç­‰æ‰‹åŠ¿è¯†åˆ«
        - ðŸš€ ä¸‰ç§åŠ¨ä½œç±»åž‹: å¯åŠ¨åº”ç”¨ã€å‘é€æŒ‰é”®ã€æ‰§è¡Œå‘½ä»¤
        - ðŸ”’ å®Œå–„çš„å¼‚å¸¸ä¿æŠ¤ï¼Œé¿å…ç³»ç»Ÿå´©æºƒ
        - âš¡ æ€§èƒ½ä¼˜åŒ–ï¼Œé…ç½®ç¼“å­˜æœºåˆ¶
        
        ### ðŸ› é—®é¢˜åé¦ˆ
        
        é‡åˆ°é—®é¢˜è¯·æäº¤ Issue: https://github.com/${{ github.repository }}/issues
        
        ### ðŸ“„ å¼€æºåè®®
        
        æœ¬é¡¹ç›®éµå¾ª Apache License 2.0 å¼€æºåè®®
        EOF
        
        echo "ðŸ“ Release è¯´æ˜Žå·²ç”Ÿæˆ"

    - name: ä¸Šä¼  Debug APK æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PowerKeyRules-Debug
        path: |
          ${{ env.DEBUG_APK_NAME }}
          ${{ env.DEBUG_APK_NAME }}.sha256

    - name: ä¸Šä¼  Release APK æž„å»ºäº§ç‰©
      if: ${{ steps.rename.outputs.release_present == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: PowerKeyRules-Release
        path: |
          ${{ env.RELEASE_APK_NAME }}
          ${{ env.RELEASE_APK_NAME }}.sha256

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      if: ${{ steps.rename.outputs.release_present == 'true' }}
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "PowerKeyRules v${{ env.VERSION_NAME }}"
        body_path: release_notes.md
        files: |
          ${{ env.DEBUG_APK_NAME }}
          ${{ env.DEBUG_APK_NAME }}.sha256
          ${{ env.RELEASE_APK_NAME }}
          ${{ env.RELEASE_APK_NAME }}.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: åˆ›å»º Debug-only Releaseï¼ˆå½“æ— ç­¾åæ—¶ï¼‰
      if: ${{ steps.rename.outputs.release_present == 'false' }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "PowerKeyRules v${{ env.VERSION_NAME }} (debug-only)"
        body_path: release_notes.md
        files: |
          ${{ env.DEBUG_APK_NAME }}
          ${{ env.DEBUG_APK_NAME }}.sha256
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æž„å»ºå®Œæˆæ€»ç»“
      run: |
        echo "ðŸŽ‰ æž„å»ºæˆåŠŸå®Œæˆ!"
        echo ""
        echo "ðŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:"
        echo "  - ${{ env.DEBUG_APK_NAME }}"
        echo "  - ${{ env.RELEASE_APK_NAME }}"
        echo ""
        echo "ðŸ”– Release æ ‡ç­¾: ${{ steps.tag.outputs.tag }}"
        echo "ðŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: v${{ env.VERSION_NAME }} (Build ${{ env.VERSION_CODE }})"
