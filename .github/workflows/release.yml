name: Build and Release APK

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: "ç‰ˆæœ¬åç§° (ä¾‹å¦‚: 1.0.0)"
        required: false
        default: ""
      version_code:
        description: "ç‰ˆæœ¬å· (æ•´æ•°ï¼Œä¾‹å¦‚: 1)"
        required: false
        default: ""
      clean_history:
        description: "æ¸…ç†æ—§ç‰ˆæœ¬å‘å¸ƒè®°å½• (ä¿ç•™æœ€æ–°)"
        required: false
        type: boolean
        default: false

permissions:
  contents: write  # åˆ›å»º Release å’Œç®¡ç† Tag æ‰€éœ€

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: "17"
        distribution: "temurin"

    - name: è®¾ç½® Android SDK
      uses: android-actions/setup-android@v3

    - name: è®¾ç½® Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: "8.2.1"

    - name: å®‰è£… Android å¹³å°å’Œæ„å»ºå·¥å…·
      run: |
        yes | sdkmanager "platforms;android-34" "build-tools;34.0.0"

    - name: ä¸‹è½½ Xposed API
      run: |
        mkdir -p app/libs
        curl -L -o app/libs/api-82.jar "https://jcenter.bintray.com/de/robv/android/xposed/api/82/api-82.jar" || \
        curl -L -o app/libs/api-82.jar "https://repo1.maven.org/maven2/de/robv/android/xposed/api/82/api-82.jar" || \
        wget -O app/libs/api-82.jar "https://github.com/rovo89/XposedBridge/releases/download/v82/api-82.jar"
        if [ ! -f app/libs/api-82.jar ] || [ ! -s app/libs/api-82.jar ]; then
          echo "Failed to download Xposed API"
          exit 1
        fi
        echo "Downloaded Xposed API ($(wc -c < app/libs/api-82.jar) bytes)"

    - name: éªŒè¯è¾“å…¥å‚æ•°
      run: |
        set -euo pipefail
        
        VERSION_NAME="${{ github.event.inputs.version_name }}"
        VERSION_CODE="${{ github.event.inputs.version_code }}"
        
        # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
        if [ -n "${VERSION_CODE}" ]; then
          if ! [[ "${VERSION_CODE}" =~ ^[0-9]+$ ]]; then
            echo "âŒ é”™è¯¯: version_code å¿…é¡»æ˜¯æ­£æ•´æ•°"
            exit 1
          fi
          if [ "${VERSION_CODE}" -lt 1 ]; then
            echo "âŒ é”™è¯¯: version_code å¿…é¡»å¤§äº 0"
            exit 1
          fi
        fi
        
        # éªŒè¯ç‰ˆæœ¬åç§°æ ¼å¼ (å…è®¸è¯­ä¹‰åŒ–ç‰ˆæœ¬)
        if [ -n "${VERSION_NAME}" ]; then
          if ! [[ "${VERSION_NAME}" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "âš ï¸  è­¦å‘Š: version_name æ ¼å¼å»ºè®®éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬ (ä¾‹å¦‚: 1.0.0)"
          fi
        fi
        
        echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

    - name: åº”ç”¨ç‰ˆæœ¬è¦†ç›–
      run: |
        set -euo pipefail
        
        VERSION_NAME="${{ github.event.inputs.version_name }}"
        VERSION_CODE="${{ github.event.inputs.version_code }}"
        
        # å¦‚æœæä¾›äº†ç‰ˆæœ¬å‚æ•°ï¼Œä¿®æ”¹ build.gradle
        if [ -n "${VERSION_NAME}" ] || [ -n "${VERSION_CODE}" ]; then
          echo "ğŸ”§ åº”ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬ä¿¡æ¯..."
          
          if [ -n "${VERSION_CODE}" ]; then
            sed -i "s/versionCode [0-9]*/versionCode ${VERSION_CODE}/" app/build.gradle
            echo "  âœ“ versionCode = ${VERSION_CODE}"
          fi
          
          if [ -n "${VERSION_NAME}" ]; then
            sed -i "s/versionName '[^']*'/versionName '${VERSION_NAME}'/" app/build.gradle
            echo "  âœ“ versionName = ${VERSION_NAME}"
          fi
          
          echo "ä¿®æ”¹åçš„ç‰ˆæœ¬ä¿¡æ¯:"
          grep -E "versionCode|versionName" app/build.gradle
        else
          echo "â„¹ï¸  ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ä¿¡æ¯"
        fi

    - name: æ¸…ç†æ„å»ºç¼“å­˜
      run: |
        echo "ğŸ§¹ æ¸…ç†æ—§æ„å»ºäº§ç‰©..."
        gradle clean
        echo "âœ… æ„å»ºç¯å¢ƒå·²æ¸…ç†"

    - name: æ„å»º Debug APK
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»º Debug APK..."
        gradle assembleDebug --stacktrace
        echo "âœ… Debug APK æ„å»ºå®Œæˆ"

    - name: æ„å»º Release APK
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»º Release APK..."
        gradle assembleRelease --stacktrace
        echo "âœ… Release APK æ„å»ºå®Œæˆ"

    - name: é‡å‘½å APK æ–‡ä»¶
      id: rename
      run: |
        set -euo pipefail
        
        VERSION_NAME="${{ github.event.inputs.version_name }}"
        VERSION_CODE="${{ github.event.inputs.version_code }}"
        
        # ä» build.gradle è¯»å–å®é™…ç‰ˆæœ¬
        ACTUAL_VERSION_NAME=$(grep "versionName" app/build.gradle | sed -E "s/.*versionName[[:space:]]*'([^']*)'.*/\1/")
        ACTUAL_VERSION_CODE=$(grep "versionCode" app/build.gradle | sed -E "s/.*versionCode[[:space:]]*([0-9]+).*/\1/")
        
        echo "å®é™…ç‰ˆæœ¬: ${ACTUAL_VERSION_NAME} (${ACTUAL_VERSION_CODE})"
        
        # ç”Ÿæˆæ–‡ä»¶å
        DEBUG_APK_NAME="PowerKeyRules-v${ACTUAL_VERSION_NAME}-debug.apk"
        RELEASE_APK_NAME="PowerKeyRules-v${ACTUAL_VERSION_NAME}-release.apk"
        
        # é‡å‘½åæ–‡ä»¶
        cp app/build/outputs/apk/debug/app-debug.apk "${DEBUG_APK_NAME}"
        cp app/build/outputs/apk/release/app-release.apk "${RELEASE_APK_NAME}"
        
        # è¾“å‡ºåˆ° GitHub env
        echo "DEBUG_APK_NAME=${DEBUG_APK_NAME}" >> $GITHUB_ENV
        echo "RELEASE_APK_NAME=${RELEASE_APK_NAME}" >> $GITHUB_ENV
        echo "VERSION_NAME=${ACTUAL_VERSION_NAME}" >> $GITHUB_ENV
        echo "VERSION_CODE=${ACTUAL_VERSION_CODE}" >> $GITHUB_ENV
        
        echo "ğŸ“¦ APK æ–‡ä»¶å·²é‡å‘½å:"
        echo "  - ${DEBUG_APK_NAME}"
        echo "  - ${RELEASE_APK_NAME}"

    - name: ç”Ÿæˆæ–‡ä»¶æ ¡éªŒå’Œ
      run: |
        echo "ğŸ” ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ..."
        sha256sum "${DEBUG_APK_NAME}" > "${DEBUG_APK_NAME}.sha256"
        sha256sum "${RELEASE_APK_NAME}" > "${RELEASE_APK_NAME}.sha256"
        
        echo "Debug APK SHA256:"
        cat "${DEBUG_APK_NAME}.sha256"
        echo ""
        echo "Release APK SHA256:"
        cat "${RELEASE_APK_NAME}.sha256"

    - name: æ¸…ç†æ—§ç‰ˆæœ¬å‘å¸ƒ
      if: ${{ github.event.inputs.clean_history == 'true' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -euo pipefail
        echo "ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬å‘å¸ƒå’Œæ ‡ç­¾..."
        
        # åˆ é™¤æ‰€æœ‰ Release
        gh release list --limit 100 --json tagName --jq '.[].tagName' | while read -r tag; do
          echo "åˆ é™¤ Release: $tag"
          gh release delete "$tag" --yes --cleanup-tag || echo "æ— æ³•åˆ é™¤ Release $tag"
        done
        
        # åˆ é™¤æ‰€æœ‰ Tag
        git tag -l | while read -r tag; do
          echo "åˆ é™¤ Tag: $tag"
          git push origin --delete "$tag" || echo "æ— æ³•åˆ é™¤è¿œç¨‹ Tag $tag"
          git tag -d "$tag" || echo "æ— æ³•åˆ é™¤æœ¬åœ° Tag $tag"
        done
        
        echo "âœ… å†å²è®°å½•æ¸…ç†å®Œæˆ"

    - name: ç”Ÿæˆ Release æ ‡ç­¾
      id: tag
      run: |
        VERSION_NAME="${{ env.VERSION_NAME }}"
        
        # ç”Ÿæˆæ—¶é—´æˆ³æ ‡ç­¾
        TAG="v${VERSION_NAME}-$(date +'%Y%m%d-%H%M%S')"
        
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "ğŸ“Œ Release æ ‡ç­¾: ${TAG}"

    - name: åˆ›å»º Release è¯´æ˜
      run: |
        VERSION_NAME="${{ env.VERSION_NAME }}"
        VERSION_CODE="${{ env.VERSION_CODE }}"
        DEBUG_APK_NAME="${{ env.DEBUG_APK_NAME }}"
        RELEASE_APK_NAME="${{ env.RELEASE_APK_NAME }}"
        
        cat > release_notes.md <<EOF
        ## PowerKeyRules - å®ä½“æŒ‰é”®è§„åˆ™å¼•æ“
        
        **ç‰ˆæœ¬**: ${VERSION_NAME} (Build ${VERSION_CODE})  
        **æ„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')
        
        ### ğŸ“¦ ä¸‹è½½è¯´æ˜
        
        | æ–‡ä»¶ | è¯´æ˜ | ç”¨é€” |
        |------|------|------|
        | \`${RELEASE_APK_NAME}\` | **æ­£å¼ç‰ˆæœ¬** (æ¨è) | æ—¥å¸¸ä½¿ç”¨ |
        | \`${DEBUG_APK_NAME}\` | è°ƒè¯•ç‰ˆæœ¬ | å¼€å‘è°ƒè¯• |
        
        ### ğŸ” æ–‡ä»¶æ ¡éªŒ
        
        **Release APK SHA256:**
        \`\`\`
        $(sha256sum "${RELEASE_APK_NAME}" | cut -d' ' -f1)
        \`\`\`
        
        **Debug APK SHA256:**
        \`\`\`
        $(sha256sum "${DEBUG_APK_NAME}" | cut -d' ' -f1)
        \`\`\`
        
        ### ğŸ“‹ å‰ç½®éœ€æ±‚
        
        - **Root ç¯å¢ƒ**: Magisk æˆ– KernelSU
        - **Xposed æ¡†æ¶**: LSPosed æˆ– LSPosed_mod
          - LSPosed: [GitHub ä¸‹è½½](https://github.com/LSPosed/LSPosed/releases)
          - LSPosed_mod: [GitHub ä¸‹è½½](https://github.com/mywalkb/LSPosed_mod/releases)
        
        ### ğŸ“± å®‰è£…æ­¥éª¤
        
        1. ç¡®ä¿å·²å®‰è£…å¹¶æ¿€æ´» LSPosed æ¡†æ¶
        2. ä¸‹è½½ \`${RELEASE_APK_NAME}\`
        3. å®‰è£… APK åˆ°è®¾å¤‡
        4. åœ¨ LSPosed Manager ä¸­:
           - å¯ç”¨ **PowerKeyRules** æ¨¡å—
           - å‹¾é€‰ä½œç”¨åŸŸ: **ç³»ç»Ÿæ¡†æ¶ (android)**
        5. é‡å¯è®¾å¤‡ä½¿æ¨¡å—ç”Ÿæ•ˆ
        
        ### âš™ï¸ é…ç½®æ–¹æ³•
        
        æ¨¡å—é‡‡ç”¨ **APK å†…ç½® WebUI** + **AIDL Service** æ¶æ„ã€‚
        
        1. æ‰“å¼€ APP ç‚¹å‡» "æ‰“å¼€ WebUI é…ç½®"
        2. åœ¨ Web ç•Œé¢æ·»åŠ /ä¿®æ”¹è§„åˆ™
        3. ç‚¹å‡»ä¿å­˜å³æ—¶ç”Ÿæ•ˆ
        
        *ä¸å†æ”¯æŒ XSharedPreferences æˆ– /data/adb ä¸‹çš„é…ç½®æ–‡ä»¶ã€‚*
        
        è¯¦ç»†é…ç½®è¯´æ˜è¯·å‚è€ƒ: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        
        ### âœ¨ ä¸»è¦ç‰¹æ€§
        
        - ğŸ¯ æ”¯æŒç”µæºé”®/éŸ³é‡é”®ç­‰å®ä½“æŒ‰é”®æ˜ å°„
        - ğŸ“ æ”¯æŒçŸ­æŒ‰ã€é•¿æŒ‰ã€åŒå‡»ç­‰æ‰‹åŠ¿è¯†åˆ«
        - ğŸš€ ä¸‰ç§åŠ¨ä½œç±»å‹: å¯åŠ¨åº”ç”¨ã€å‘é€æŒ‰é”®ã€æ‰§è¡Œå‘½ä»¤
        - ğŸ”’ å®Œå–„çš„å¼‚å¸¸ä¿æŠ¤ï¼Œé¿å…ç³»ç»Ÿå´©æºƒ
        - âš¡ æ€§èƒ½ä¼˜åŒ–ï¼Œé…ç½®ç¼“å­˜æœºåˆ¶
        
        ### ğŸ› é—®é¢˜åé¦ˆ
        
        é‡åˆ°é—®é¢˜è¯·æäº¤ Issue: https://github.com/${{ github.repository }}/issues
        
        ### ğŸ“„ å¼€æºåè®®
        
        æœ¬é¡¹ç›®éµå¾ª Apache License 2.0 å¼€æºåè®®
        EOF
        
        echo "ğŸ“ Release è¯´æ˜å·²ç”Ÿæˆ"

    - name: ä¸Šä¼  Debug APK æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PowerKeyRules-Debug
        path: |
          ${{ env.DEBUG_APK_NAME }}
          ${{ env.DEBUG_APK_NAME }}.sha256

    - name: ä¸Šä¼  Release APK æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: PowerKeyRules-Release
        path: |
          ${{ env.RELEASE_APK_NAME }}
          ${{ env.RELEASE_APK_NAME }}.sha256

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: "PowerKeyRules v${{ env.VERSION_NAME }}"
        body_path: release_notes.md
        files: |
          ${{ env.DEBUG_APK_NAME }}
          ${{ env.DEBUG_APK_NAME }}.sha256
          ${{ env.RELEASE_APK_NAME }}
          ${{ env.RELEASE_APK_NAME }}.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: æ„å»ºå®Œæˆæ€»ç»“
      run: |
        echo "ğŸ‰ æ„å»ºæˆåŠŸå®Œæˆ!"
        echo ""
        echo "ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:"
        echo "  - ${{ env.DEBUG_APK_NAME }}"
        echo "  - ${{ env.RELEASE_APK_NAME }}"
        echo ""
        echo "ğŸ”– Release æ ‡ç­¾: ${{ steps.tag.outputs.tag }}"
        echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯: v${{ env.VERSION_NAME }} (Build ${{ env.VERSION_CODE }})"
