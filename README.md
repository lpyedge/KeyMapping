# PowerKeyRules - Android å¯¦é«”æŒ‰éµæ˜ å°„æ¨¡çµ„

åŸºæ–¼ **LSPosed Modern API** çš„ Android å¯¦é«”æŒ‰éµè‡ªè¨‚æ˜ å°„æ¨¡çµ„ï¼Œé€šé Hook `PhoneWindowManager.interceptKeyBeforeQueueing` å¯¦ç¾æŒ‰éµè¡Œç‚ºé‡å®šç¾©ã€‚

## ç‰¹æ€§

- âœ… æ”¯æ´é•·æŒ‰ã€é›™æ“Šã€å–®æ“Šç­‰å¤šç¨®æ‰‹å‹¢è­˜åˆ¥
- âœ… ä¸‰ç¨®å‹•ä½œé¡å‹ï¼šå•Ÿå‹• Intentã€ç™¼é€æŒ‰éµäº‹ä»¶ã€åŸ·è¡Œ Shell å‘½ä»¤
- âœ… APK å…§å»º WebUI å¯è¦–åŒ–é…ç½®ç•Œé¢
- âœ… **Modern API**ï¼šä½¿ç”¨ [`libxposed/api`](https://libxposed.github.io/api/) v29+ï¼Œæ”¯æ´ Remote Preferences
- âœ… é˜²å´©æ½°è¨­è¨ˆï¼ˆé›»æºéµ DOWN æ°¸ä¸æ””æˆª + å…¨å±€ç•°å¸¸æ•ç² + éæ­¸é˜²è­·ï¼‰
- âœ… æ€§èƒ½å„ªåŒ–ï¼ˆç°½åå¿«å– + 1 ç§’ reload ç¯€æµ + å‹•ä½œéšŠåˆ—é™åˆ¶ï¼‰

---

## å‰ç½®éœ€æ±‚

### å¿…éœ€ç’°å¢ƒ

1. **Root æ¬Šé™**: Magisk æˆ– KernelSU
2. **Xposed æ¡†æ¶**ï¼ˆéœ€æ”¯æ´ Modern APIï¼‰:
   - [LSPosed](https://github.com/LSPosed/LSPosed/releases) **v1.9.1+**ï¼ˆå¿…é ˆæ”¯æ´ API 29ï¼‰
   - [LSPosed_mod](https://github.com/mywalkb/LSPosed_mod/releases) (Zygiskï¼Œéœ€æ”¯æ´ API 29)

> âš ï¸ **é‡è¦**ï¼šæœ¬æ¨¡çµ„ä½¿ç”¨ Modern Xposed API v29ï¼Œéœ€è¦ **LSPosed 1.9.1 æˆ–æ›´é«˜ç‰ˆæœ¬**ã€‚èˆŠç‰ˆ LSPosed ç„¡æ³•è¼‰å…¥æ­¤æ¨¡çµ„ã€‚

### å®‰è£æ­¥é©Ÿ

```bash
# 1. ç¢ºä¿è¨­å‚™å·² Root
# 2. å®‰è£ LSPosed æ¨¡çµ„ä¸¦é‡å•Ÿ
# 3. å®‰è£æœ¬æ¨¡çµ„ APK
# 4. åœ¨ LSPosed Manager ä¸­ï¼š
#    - å•Ÿç”¨ã€ŒPowerKeyRulesã€
#    - å‹¾é¸ä½œç”¨åŸŸï¼šç³»çµ±æ¡†æ¶ (android)
# 5. é‡å•Ÿè¨­å‚™ç”Ÿæ•ˆ
```

---

## ç·¨è­¯æ§‹å»º

### ç³»çµ±è¦æ±‚

- JDK 17+
- Gradle 8.2+
- ç¶²çµ¡é€£æ¥ï¼ˆé¦–æ¬¡æ§‹å»ºæ™‚å¾ JitPack ä¸‹è¼‰ libxposed/apiï¼‰

### ä¾è³´èªªæ˜

æœ¬å°ˆæ¡ˆä½¿ç”¨ [Modern Xposed API](https://libxposed.github.io/api/)ï¼š

| ä¾è³´ | ç‰ˆæœ¬ | ä¾†æº |
|------|------|------|
| `io.github.libxposed:api` | 29 | JitPack |

> ğŸ“¦ **é›¢ç·šæ§‹å»º**ï¼šå·²åœ¨ `app/libs/` ç›®éŒ„æä¾› `Modern_Xposed_API-29.aar` ä½œç‚º fallbackï¼Œç„¡ç¶²çµ¡æ™‚ä¹Ÿå¯ç·¨è­¯ã€‚

### Windows

```batch
gradlew.bat assembleRelease    # Release ç‰ˆæœ¬
gradlew.bat assembleDebug      # Debug ç‰ˆæœ¬
gradlew.bat clean              # æ¸…ç†
```

### Linux/macOS

```bash
./gradlew assembleRelease      # Release ç‰ˆæœ¬
./gradlew assembleDebug        # Debug ç‰ˆæœ¬
./gradlew clean                # æ¸…ç†
```

**è¼¸å‡º**: `app/build/outputs/apk/release/app-release.apk`

---

## é…ç½®æ–¹å¼

### ğŸ“± æ¨è–¦æ–¹å¼ï¼šAPK å…§å»º WebUI

1. æ‰“é–‹ã€ŒPowerKeyRulesã€æ‡‰ç”¨
2. é»æ“Šã€Œæ‰“é–‹ WebUI é…ç½®ã€
3. åœ¨å¯è¦–åŒ–ç•Œé¢ä¸­æ·»åŠ /ç·¨è¼¯è¦å‰‡
4. é»æ“Šã€Œä¿å­˜ã€å³æ™‚ç”Ÿæ•ˆ

### ğŸ“ JSON é…ç½®çµæ§‹

```json
{
  "version": 1,
  "doublePressIntervalMs": 300,
  "longPressMinMs": 500,
  "rules": [
    {
      "keyCode": 26,
      "behavior": "LONG_PRESS",
      "durationMs": 500,
      "action": {
        "type": "launch_intent",
        "intent": {
          "action": "android.intent.action.VOICE_ASSIST"
        }
      }
    }
  ]
}
```

#### å…¨å±€åƒæ•¸

| åƒæ•¸ | èªªæ˜ | é è¨­å€¼ |
|------|------|--------|
| `version` | é…ç½®ç‰ˆæœ¬ | 1 |
| `doublePressIntervalMs` | é›™æ“Šåˆ¤å®šé–“éš”ï¼ˆæ¯«ç§’ï¼‰ | 300 |
| `longPressMinMs` | é•·æŒ‰åˆ¤å®šé–¾å€¼ï¼ˆæ¯«ç§’ï¼‰ | 500 |

#### è¦å‰‡æ¬„ä½ (rules)

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| `keyCode` | Int | Android æŒ‰éµä»£ç¢¼ï¼ˆ26=é›»æºéµ, 24/25=éŸ³é‡éµï¼‰ |
| `behavior` | String | æ“ä½œé¡å‹ï¼ˆè¦‹ä¸‹è¡¨ï¼‰ |
| `durationMs` | Long | é•·æŒ‰é–¾å€¼ï¼ˆåƒ… `LONG_PRESS` å’Œç›¸é—œé¡å‹éœ€è¦ï¼‰ |
| `comboKeyCode` | Int | çµ„åˆéµçš„ç¬¬äºŒå€‹æŒ‰éµï¼ˆåƒ… `COMBO_*` é¡å‹éœ€è¦ï¼‰ |
| `action` | Object | åŸ·è¡Œå‹•ä½œï¼ˆè¦‹ä¸‹æ–‡ï¼‰ |

---

## æ”¯æ´çš„æŒ‰éµæ“ä½œé‚è¼¯

### ğŸ“‹ **æ“ä½œé¡å‹ç¸½è¦½**

| æ“ä½œé¡å‹ | behavior å€¼ | è§¸ç™¼æ™‚æ©Ÿ | éœ€è¦ durationMs | éœ€è¦ comboKeyCode | èªªæ˜ |
|---------|------------|---------|----------------|------------------|------|
| **å–®æ“Šï¼ˆUPï¼‰** | `UP` | æŒ‰éµé‡‹æ”¾æ™‚ | âŒ å¦ | âŒ å¦ | çŸ­æŒ‰å¾Œé‡‹æ”¾ï¼Œæœªé”åˆ°é•·æŒ‰é–¾å€¼ |
| **æŒ‰ä¸‹ï¼ˆDOWNï¼‰** | `DOWN` | æŒ‰éµæŒ‰ä¸‹æ™‚ | âŒ å¦ | âŒ å¦ | ç«‹å³è§¸ç™¼ï¼Œä¸ç­‰å¾…é‡‹æ”¾ |
| **é•·æŒ‰** | `LONG_PRESS` | æŒ‰ä½æœŸé–“ | âœ… æ˜¯ | âŒ å¦ | æŒ‰ä½é”åˆ°æŒ‡å®šæ™‚é•·è‡ªå‹•è§¸ç™¼ |
| **é•·æŒ‰é‡‹æ”¾** | `LONG_PRESS_RELEASE` | é•·æŒ‰å¾Œé‡‹æ”¾æ™‚ | âœ… æ˜¯ | âŒ å¦ | é•·æŒ‰å¾Œé‡‹æ”¾ç¬é–“è§¸ç™¼ |
| **é›™æ“Š** | `DOUBLE_PRESS` | ç¬¬äºŒæ¬¡é‡‹æ”¾æ™‚ | âŒ å¦ | âŒ å¦ | å…©æ¬¡çŸ­æŒ‰é–“éš” < 300ms |
| **çµ„åˆéµæŒ‰ä¸‹** | `COMBO_DOWN` | å…©éµåŒæ™‚æŒ‰ä¸‹ | âŒ å¦ | âœ… æ˜¯ | ç¬¬äºŒå€‹éµæŒ‰ä¸‹ç¬é–“è§¸ç™¼ |
| **çµ„åˆéµé•·æŒ‰** | `COMBO_LONG_PRESS` | å…©éµæŒ‰ä½æœŸé–“ | âœ… æ˜¯ | âœ… æ˜¯ | å…©éµæŒ‰ä½é”åˆ°é–¾å€¼è§¸ç™¼ |

---

### ğŸ” **è©³ç´°èªªæ˜**

#### 1. **å–®æ“Šï¼ˆUPï¼‰** - çŸ­æŒ‰é‡‹æ”¾

**è§¸ç™¼æ¢ä»¶**ï¼š
- æŒ‰ä¸‹ â†’ é‡‹æ”¾
- æŒ‰ä½æ™‚é•· < `longPressMinMs`ï¼ˆé è¨­ 500msï¼‰
- ä¸æ˜¯é›™æ“Šçš„ç¬¬äºŒæ¬¡æŒ‰ä¸‹

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "keyCode": 26,
  "behavior": "UP",
  "action": {
    "type": "launch_intent",
    "intent": {"action": "android.settings.SETTINGS"}
  }
}
```

**è§¸ç™¼æµç¨‹**ï¼š
```
DOWN (0ms) â†’ é‡‹æ”¾ UP (200ms) â†’ âœ… è§¸ç™¼ UP è¦å‰‡
```

---

#### 2. **æŒ‰ä¸‹ï¼ˆDOWNï¼‰** - ç«‹å³éŸ¿æ‡‰

**è§¸ç™¼æ¢ä»¶**ï¼š
- æŒ‰éµæŒ‰ä¸‹çš„ç¬é–“
- ä¸ç­‰å¾…é‡‹æ”¾

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "keyCode": 24,
  "behavior": "DOWN",
  "action": {
    "type": "run_shell",
    "command": "input keyevent 24"
  }
}
```

**è§¸ç™¼æµç¨‹**ï¼š
```
DOWN (0ms) â†’ âœ… ç«‹å³è§¸ç™¼ DOWN è¦å‰‡
```

âš ï¸ **æ³¨æ„**ï¼šé›»æºéµçš„ DOWN äº‹ä»¶æ°¸ä¸æ””æˆªï¼Œç¢ºä¿è¨­å‚™èƒ½æ­£å¸¸å–šé†’ã€‚åœ¨è§„åˆ™æ–°å¢å’Œä¿®æ”¹æ—¶å°±åšé™åˆ¶ä¸å…è®¸ä¿å­˜ã€‚

---

#### 3. **é•·æŒ‰ï¼ˆLONG_PRESSï¼‰** - å¤šéšæ®µè§¸ç™¼

**è§¸ç™¼æ¢ä»¶**ï¼š
- æŒ‰ä½æ™‚é•·é”åˆ° `durationMs` é–¾å€¼
- **åœ¨æŒ‰ä½æœŸé–“è‡ªå‹•è§¸ç™¼ï¼Œèˆ‡é‡‹æ”¾ç„¡é—œ**
- æ”¯æŒå¤šå€‹é•·æŒ‰è¦å‰‡ï¼ˆ500msã€2000ms ç­‰ï¼‰

**é…ç½®ç¤ºä¾‹**ï¼š
```json
[
  {
    "keyCode": 26,
    "behavior": "LONG_PRESS",
    "durationMs": 500,
    "action": {
      "type": "launch_intent",
      "intent": {"action": "android.intent.action.VOICE_ASSIST"}
    }
  },
  {
    "keyCode": 26,
    "behavior": "LONG_PRESS",
    "durationMs": 2000,
    "action": {
      "type": "run_shell",
      "command": "input keyevent 26"
    }
  }
]
```

**è§¸ç™¼æµç¨‹**ï¼ˆå¤šéšæ®µï¼‰ï¼š
```
DOWN (0ms) 
  â†’ æŒ‰ä½...
  â†’ 500ms âœ… è§¸ç™¼ç¬¬ä¸€å€‹è¦å‰‡ï¼ˆèªéŸ³åŠ©æ‰‹ï¼‰
  â†’ ç¹¼çºŒæŒ‰ä½...
  â†’ 2000ms âœ… è§¸ç™¼ç¬¬äºŒå€‹è¦å‰‡ï¼ˆé›»æºèœå–®ï¼‰
  â†’ é‡‹æ”¾ UP (2500ms) â†’ åªæ¸…ç†ç‹€æ…‹ï¼Œä¸è§¸ç™¼å‹•ä½œ
```

**æŠ€è¡“å¯¦ç¾**ï¼š
- ä½¿ç”¨å¾Œå°å®šæ™‚å™¨ï¼ˆæ¯ 50ms æª¢æŸ¥ä¸€æ¬¡ï¼‰
- é”åˆ°é–¾å€¼ç«‹å³åŸ·è¡Œå‹•ä½œ
- æ¯å€‹é–¾å€¼åªè§¸ç™¼ä¸€æ¬¡ï¼ˆé˜²æ­¢é‡è¤‡ï¼‰
- UP äº‹ä»¶åªæ¸…ç†è¨ˆæ™‚å™¨ï¼Œä¸åƒèˆ‡é•·æŒ‰è§¸ç™¼

**durationMs åƒæ•¸**ï¼š
- **å¿…å¡«**ï¼Œå–®ä½æ¯«ç§’
- å¯ä»¥æœ‰å¤šå€‹ä¸åŒæ™‚é•·çš„é•·æŒ‰è¦å‰‡
- å»ºè­°é–“éš” â‰¥ 500ms é¿å…èª¤è§¸

---

#### 4. **é›™æ“Šï¼ˆDOUBLE_PRESSï¼‰** - å¿«é€Ÿé€£æŒ‰

**è§¸ç™¼æ¢ä»¶**ï¼š
- å…©æ¬¡çŸ­æŒ‰é–“éš” < `doublePressIntervalMs`ï¼ˆé è¨­ 300msï¼‰
- å…©æ¬¡æŒ‰å£“éƒ½è¦çŸ­æ–¼é•·æŒ‰é–¾å€¼

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "keyCode": 26,
  "behavior": "DOUBLE_PRESS",
  "action": {
    "type": "send_key",
    "keyCode": 27
  }
}
```

**è§¸ç™¼æµç¨‹**ï¼š
```
DOWN â†’ UP (100ms)  [ç¬¬ä¸€æ¬¡]
  â†’ DOWN â†’ UP (250ms)  [ç¬¬äºŒæ¬¡ï¼Œé–“éš” 150ms < 300ms]
  â†’ âœ… è§¸ç™¼ DOUBLE_PRESS è¦å‰‡
```

âš ï¸ **é™åˆ¶**ï¼šç¬¬ä¸€æ¬¡æŒ‰ä¸‹æœƒè§¸ç™¼å–®æ“Šè¦å‰‡ï¼ˆå¦‚æœæœ‰é…ç½®ï¼‰ï¼Œé€™æ˜¯è¼•é‡ç´šæ””æˆªå™¨çš„é€šç”¨æ¬Šè¡¡ã€‚å»ºè­°é¿å…åŒæ™‚é…ç½®åŒä¸€æŒ‰éµçš„ UP å’Œ DOUBLE_PRESSã€‚

---

#### 5. **é•·æŒ‰é‡‹æ”¾ï¼ˆLONG_PRESS_RELEASEï¼‰** - é•·æŒ‰å¾Œé‡‹æ”¾

**è§¸ç™¼æ¢ä»¶**ï¼š
- é•·æŒ‰é”åˆ° `durationMs` å¾Œé‡‹æ”¾æŒ‰éµ
- **åœ¨é‡‹æ”¾ç¬é–“è§¸ç™¼ï¼Œä¸æœƒèˆ‡ LONG_PRESS è¡çª**
- é©åˆéœ€è¦åœ¨é‡‹æ”¾æ™‚åŸ·è¡Œçš„æ“ä½œ

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "keyCode": 26,
  "behavior": "LONG_PRESS_RELEASE",
  "durationMs": 2000,
  "action": {
    "type": "run_shell",
    "command": "am broadcast -a android.intent.action.SHOW_BRIGHTNESS_DIALOG"
  }
}
```

**è§¸ç™¼æµç¨‹**ï¼š
```
DOWN (0ms) 
  â†’ æŒ‰ä½...
  â†’ 2000msï¼ˆé”åˆ°é–¾å€¼ï¼Œä½†ä¸è§¸ç™¼ï¼‰
  â†’ ç¹¼çºŒæŒ‰ä½...
  â†’ é‡‹æ”¾ UP (2500ms) â†’ âœ… è§¸ç™¼ LONG_PRESS_RELEASE è¦å‰‡
```

**èˆ‡ LONG_PRESS çš„å€åˆ¥**ï¼š
- `LONG_PRESS`: é”åˆ°æ™‚é•·**ç«‹å³**è§¸ç™¼ï¼ˆæŒ‰ä½æœŸé–“ï¼‰
- `LONG_PRESS_RELEASE`: é”åˆ°æ™‚é•·å¾Œ**é‡‹æ”¾æ™‚**æ‰è§¸ç™¼

**å¸¸è¦‹ç”¨é€”**ï¼š
- é•·æŒ‰é›»æºéµ 2 ç§’å¾Œé‡‹æ”¾ï¼šé¡¯ç¤ºäº®åº¦å°è©±æ¡†
- é•·æŒ‰éŸ³é‡éµå¾Œé‡‹æ”¾ï¼šåˆ‡æ›æƒ…æ™¯æ¨¡å¼

---

#### 6. **çµ„åˆéµæŒ‰ä¸‹ï¼ˆCOMBO_DOWNï¼‰** - å…©éµåŒæ™‚æŒ‰

**è§¸ç™¼æ¢ä»¶**ï¼š
- ç¬¬ä¸€å€‹éµå·²æŒ‰ä¸‹ï¼Œç¬¬äºŒå€‹éµæŒ‰ä¸‹ç¬é–“è§¸ç™¼
- ç„¡é †åºè¦æ±‚ï¼ˆkeyCode å’Œ comboKeyCode å¯ä»¥äº’æ›ï¼‰
- ä¸ç­‰å¾…é‡‹æ”¾

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "keyCode": 26,
  "behavior": "COMBO_DOWN",
  "comboKeyCode": 24,
  "action": {
    "type": "run_shell",
    "command": "input keyevent 120"
  }
}
```

**è§¸ç™¼æµç¨‹**ï¼š
```
DOWN é›»æºéµ (0ms)
  â†’ DOWN éŸ³é‡ä¸Š (100ms) â†’ âœ… è§¸ç™¼ COMBO_DOWN è¦å‰‡ï¼ˆæˆªå±ï¼‰
```

**comboKeyCode åƒæ•¸**ï¼š
- **å¿…å¡«**ï¼Œç¬¬äºŒå€‹æŒ‰éµçš„ keyCode
- å¯ä»¥èˆ‡ keyCode äº’æ›ï¼ˆ24+26 å’Œ 26+24 æ˜¯åŒä¸€çµ„åˆï¼‰

**å¸¸è¦‹ç”¨é€”**ï¼š
- é›»æºéµ + éŸ³é‡ä¸Šï¼šæˆªå±ï¼ˆAndroid æ¨™æº–å¿«æ·éµï¼‰
- éŸ³é‡ä¸Š + éŸ³é‡ä¸‹ï¼šéœéŸ³
- é›»æºéµ + éŸ³é‡ä¸‹ï¼šé€²å…¥ Recovery

---

#### 7. **çµ„åˆéµé•·æŒ‰ï¼ˆCOMBO_LONG_PRESSï¼‰** - å…©éµåŒæ™‚é•·æŒ‰

**è§¸ç™¼æ¢ä»¶**ï¼š
- å…©å€‹éµéƒ½æŒ‰ä¸‹å¾Œï¼ŒæŒ‰ä½é”åˆ° `durationMs` é–¾å€¼
- **ä»¥ç¬¬äºŒå€‹éµæŒ‰ä¸‹çš„æ™‚é–“é–‹å§‹è¨ˆæ™‚**
- åœ¨æŒ‰ä½æœŸé–“è‡ªå‹•è§¸ç™¼ï¼ˆé¡ä¼¼ LONG_PRESSï¼‰

**é…ç½®ç¤ºä¾‹**ï¼š
```json
{
  "keyCode": 24,
  "behavior": "COMBO_LONG_PRESS",
  "comboKeyCode": 25,
  "durationMs": 1000,
  "action": {
    "type": "run_shell",
    "command": "cmd audio set-ringer-mode silent"
  }
}
```

**è§¸ç™¼æµç¨‹**ï¼š
```
DOWN éŸ³é‡ä¸Š (0ms)
  â†’ DOWN éŸ³é‡ä¸‹ (100ms)  [è¨ˆæ™‚é–‹å§‹]
  â†’ æŒ‰ä½...
  â†’ 1100ms âœ… è§¸ç™¼ COMBO_LONG_PRESS è¦å‰‡ï¼ˆéœéŸ³æ¨¡å¼ï¼‰
  â†’ é‡‹æ”¾ä»»ä¸€éµ â†’ åªæ¸…ç†ç‹€æ…‹ï¼Œä¸è§¸ç™¼å‹•ä½œ
```

**æŠ€è¡“å¯¦ç¾**ï¼š
- ç¬¬äºŒå€‹éµæŒ‰ä¸‹å¾Œå•Ÿå‹•å®šæ™‚å™¨
- æ¯ 50ms æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦é”åˆ°é–¾å€¼
- é‡‹æ”¾ä»»ä¸€éµå–æ¶ˆè¨ˆæ™‚å™¨

**durationMs åƒæ•¸**ï¼š
- **å¿…å¡«**ï¼Œå–®ä½æ¯«ç§’
- æ”¯æŒå¤šéšæ®µé•·æŒ‰ï¼ˆé¡ä¼¼å–®éµé•·æŒ‰ï¼‰

**å¸¸è¦‹ç”¨é€”**ï¼š
- éŸ³é‡ä¸Š+ä¸‹é•·æŒ‰ 1 ç§’ï¼šåˆ‡æ›éœéŸ³
- é›»æºéµ+éŸ³é‡ä¸Šé•·æŒ‰ 3 ç§’ï¼šå¼·åˆ¶é‡å•Ÿ
- éŸ³é‡ä¸Š+ä¸‹é•·æŒ‰ 5 ç§’ï¼šå®‰å…¨æ¨¡å¼

---

### ğŸ¯ **è¦å‰‡å„ªå…ˆç´šèˆ‡è¡çªè™•ç†**

#### å„ªå…ˆç´šé †åºï¼ˆç”±é«˜åˆ°ä½ï¼‰ï¼š
1. **COMBO_DOWN** / **DOWN** - æŒ‰ä¸‹ç¬é–“è§¸ç™¼
2. **COMBO_LONG_PRESS** / **LONG_PRESS** - æŒ‰ä½æœŸé–“é”åˆ°é–¾å€¼æ™‚è§¸ç™¼
3. **LONG_PRESS_RELEASE** - é•·æŒ‰å¾Œé‡‹æ”¾æ™‚è§¸ç™¼
4. **DOUBLE_PRESS** - ç¬¬äºŒæ¬¡é‡‹æ”¾æ™‚åˆ¤å®š
5. **UP** - æœ€å¾Œé‡‹æ”¾æ™‚è§¸ç™¼

#### è¡çªå ´æ™¯ï¼š

**å ´æ™¯ 1ï¼šé•·æŒ‰ vs é•·æŒ‰é‡‹æ”¾ vs å–®æ“Š**
```json
// å¯ä»¥å…±å­˜ï¼Œä¸è¡çª
{"behavior": "LONG_PRESS", "durationMs": 500}          // 500ms æ™‚ç«‹å³è§¸ç™¼
{"behavior": "LONG_PRESS_RELEASE", "durationMs": 500}  // 500ms å¾Œé‡‹æ”¾æ™‚è§¸ç™¼
{"behavior": "UP"}                                      // çŸ­æŒ‰è§¸ç™¼
```
- æŒ‰ä½ 500msï¼šè§¸ç™¼ LONG_PRESS
- ç¹¼çºŒæŒ‰ä½åˆ° 600ms å¾Œé‡‹æ”¾ï¼šè§¸ç™¼ LONG_PRESS_RELEASE
- æŒ‰ä½ < 500ms å¾Œé‡‹æ”¾ï¼šè§¸ç™¼ UP

**å ´æ™¯ 2ï¼šçµ„åˆéµ vs å–®éµ**
```json
// å¯ä»¥å…±å­˜ï¼ŒæŒ‰å…ˆå¾Œé †åºåˆ¤æ–·
{"keyCode": 26, "behavior": "COMBO_DOWN", "comboKeyCode": 24}  // å„ªå…ˆåˆ¤æ–·çµ„åˆéµ
{"keyCode": 26, "behavior": "DOWN"}                             // å–®éµå…œåº•
```
- é›»æºéµ + éŸ³é‡ä¸Šï¼šè§¸ç™¼ COMBO_DOWN
- åƒ…é›»æºéµï¼šè§¸ç™¼ DOWN

**å ´æ™¯ 3ï¼šå¤šéšæ®µçµ„åˆéµé•·æŒ‰**
```json
// å®Œå…¨æ”¯æ´
{"behavior": "COMBO_LONG_PRESS", "durationMs": 1000}  // 1 ç§’æ™‚è§¸ç™¼
{"behavior": "COMBO_LONG_PRESS", "durationMs": 3000}  // 3 ç§’æ™‚è§¸ç™¼
```

---

### ğŸ”® **æœªå¯¦ç¾çš„æ“´å±•æ“ä½œ**

ä»¥ä¸‹æ˜¯ç†è«–ä¸Šå¯ä»¥æ“´å±•ä½†**å°šæœªå¯¦ç¾**çš„æ“ä½œé¡å‹ï¼š

#### 1. **ä¸‰æ“Šï¼ˆTRIPLE_PRESSï¼‰**
- **ç‹€æ…‹**ï¼šâŒ ä¸è€ƒæ…®å¯¦ç¾ï¼ˆéæ–¼è¤‡é›œï¼Œå¯¦ç”¨æ€§ä½ï¼‰

#### 2. **é€£çºŒé•·æŒ‰ï¼ˆREPEATED_LONG_PRESSï¼‰**
- **è§¸ç™¼æ¢ä»¶**ï¼šé•·æŒ‰æœŸé–“é‡è¤‡è§¸ç™¼
- **éœ€è¦åƒæ•¸**ï¼š`intervalMs`ï¼ˆé‡è¤‡é–“éš”ï¼‰
- **å¯¦ç¾é›£åº¦**ï¼šâ­â­ ç°¡å–®
- **ç‹€æ…‹**ï¼šæœªå¯¦ç¾

---

### å‹•ä½œé¡å‹ (Action)

#### 1. å•Ÿå‹• Intent (`launch_intent`)

```json
{
  "type": "launch_intent",
  "intent": {
    "action": "android.intent.action.VOICE_ASSIST"
  }
}
```

**å¸¸ç”¨ç¤ºä¾‹**:

```json
// èªéŸ³åŠ©æ‰‹
{"action": "android.intent.action.VOICE_ASSIST"}

// ç›¸æ©Ÿ
{"action": "android.media.action.STILL_IMAGE_CAMERA"}

// æŒ‡å®šæ‡‰ç”¨
{
  "action": "android.intent.action.MAIN",
  "package": "com.android.settings",
  "className": "com.android.settings.Settings"
}
```

#### 2. ç™¼é€æŒ‰éµäº‹ä»¶ (`send_key`)

```json
{
  "type": "send_key",
  "keyCode": 27
}
```

**å¸¸ç”¨æŒ‰éµä»£ç¢¼**:
- `27` - ç›¸æ©Ÿéµ
- `223` - ä¼‘çœ /é—œå± (SLEEP)
- `224` - å–šé†’/äº®å± (WAKEUP)
- `85` - æ’­æ”¾/æš«åœ

#### 3. åŸ·è¡Œ Shell å‘½ä»¤ (`run_shell`)

```json
{
  "type": "run_shell",
  "command": "input keyevent 223"
}
```

**å¸¸ç”¨å‘½ä»¤**:
```bash
# æˆªåœ–
input keyevent 120

# é—œé–‰å±å¹•
input keyevent 223

# æ»‘å‹•è§£é–
input swipe 500 1500 500 500
```

---

## æŠ€è¡“æ¶æ§‹

### é…ç½®æµç¨‹ï¼ˆModern APIï¼‰

```
ç”¨æˆ¶æ“ä½œ WebUI (APK)
    â†“
ä¿å­˜åˆ° SharedPreferences (device-protected storage)
    â†“
system_server é€šé Remote Preferences è®€å–é…ç½®
    â†“ (ç„¡éœ€ AIDLï¼Œæ¡†æ¶è‡ªå‹•è™•ç†è·¨é€²ç¨‹é€šä¿¡)
ModernRuleStore å¿«å–è¦å‰‡ + ç°½åæª¢æ¸¬
    â†“
æŒ‰éµäº‹ä»¶è§¸ç™¼ â†’ KeyRuleEngine åŒ¹é…è¦å‰‡
    â†“
ActionExecutor åŸ·è¡Œå‹•ä½œï¼ˆIntent/KeyEvent/Shellï¼‰
```

### æ ¸å¿ƒçµ„ä»¶

| çµ„ä»¶ | è·è²¬ |
|------|------|
| `PowerKeyModule` | Modern API å…¥å£ï¼Œå¯¦ç¾ `XposedModule`ï¼Œè™•ç† `onSystemServerLoaded` |
| `InterceptKeyHooker` | è¨»è§£å¼ Hookerï¼Œæ””æˆªæŒ‰éµäº‹ä»¶ |
| `KeyStateTracker` | æ‰‹å‹¢æª¢æ¸¬ï¼ˆé•·æŒ‰/é›™æ“Š/å–®æ“Šï¼‰ |
| `KeyRuleEngine` | è¦å‰‡åŒ¹é…é‚è¼¯ |
| `ModernRuleStore` | é…ç½®åŠ è¼‰ï¼ˆä½¿ç”¨ Remote Preferencesï¼‰ |
| `ActionExecutor` | å‹•ä½œåŸ·è¡Œï¼ˆå¸¶éšŠåˆ—é™åˆ¶èˆ‡è¶…æ™‚ï¼‰ |

### å®‰å…¨æ©Ÿåˆ¶

- âœ… **é›»æºéµ DOWN æ°¸ä¸æ””æˆª**: ä¿è­‰å–šé†’åŠŸèƒ½ä¸å—å½±éŸ¿
- âœ… **éæ­¸é˜²è­·**: 100ms å…§åŒä¸€ keyCode+action ä¸é‡è¤‡è§¸ç™¼
- âœ… **å…¨å±€ç•°å¸¸æ•ç²**: Hook èˆ‡å‹•ä½œåŸ·è¡Œéƒ½æœ‰ try/catch ä¿è­·
- âœ… **å‹•ä½œéšŠåˆ—é™åˆ¶**: æœ€å¤š 10 å€‹å¾…åŸ·è¡Œå‹•ä½œï¼Œé˜²æ­¢å †ç©
- âœ… **Shell è¶…æ™‚**: å‘½ä»¤åŸ·è¡Œè¶…é 5 ç§’è‡ªå‹•çµ‚æ­¢

### æ€§èƒ½å„ªåŒ–

- âš¡ **Remote Preferences**: æ¡†æ¶ç´šè·¨é€²ç¨‹å…±äº«ï¼Œç„¡éœ€è‡ªå»º AIDL
- âš¡ **ç°½åå¿«å–**: åƒ…æ¯”è¼ƒ `updatedAt` æ™‚é–“æˆ³ï¼Œé¿å…é‡è¤‡è®€å– JSON
- âš¡ **1 ç§’ç¯€æµ**: reload æª¢æŸ¥é–“éš”æœ€å° 1000ms
- âš¡ **deoptimize**: å° Hook ç›®æ¨™æ–¹æ³•é€²è¡Œå»å„ªåŒ–ï¼Œæå‡ç©©å®šæ€§
- âš¡ **å¾Œå°åŸ·è¡Œ**: Shell/Intent åœ¨ç¨ç«‹ç·šç¨‹åŸ·è¡Œï¼Œä¸é˜»å¡æŒ‰éµéŸ¿æ‡‰

---

## é è¨­è¦å‰‡

æœªé…ç½®æ™‚ä½¿ç”¨ä»¥ä¸‹é è¨­è¦å‰‡ï¼š

```json
{
  "version": 1,
  "doublePressIntervalMs": 300,
  "longPressMinMs": 500,
  "rules": [
    {
      "keyCode": 26,
      "behavior": "LONG_PRESS",
      "durationMs": 500,
      "action": {
        "type": "launch_intent",
        "intent": {"action": "android.intent.action.VOICE_ASSIST"}
      }
    },
    {
      "keyCode": 26,
      "behavior": "DOUBLE_PRESS",
      "durationMs": 0,
      "action": {
        "type": "send_key",
        "keyCode": 27
      }
    }
  ]
}
```

- **é›»æºéµé•·æŒ‰ 500ms**: å•Ÿå‹•èªéŸ³åŠ©æ‰‹
- **é›»æºéµé›™æ“Š**: è§¸ç™¼ç›¸æ©Ÿéµäº‹ä»¶

---

## é™åˆ¶èˆ‡æ³¨æ„äº‹é …

### âš ï¸ å·²çŸ¥é™åˆ¶

1. **é›™æ“Šç¬¬ä¸€æ¬¡æŒ‰éµæœƒè§¸ç™¼å–®æ“Šè¦å‰‡**
   - é€™æ˜¯è¼•é‡ç´šæ””æˆªå™¨çš„é€šç”¨æ¬Šè¡¡
   - å»ºè­°ï¼šé¿å…åŒæ™‚é…ç½®åŒä¸€æŒ‰éµçš„å–®æ“Šå’Œé›™æ“Šè¦å‰‡

2. **é•·æŒ‰å¯èƒ½èˆ‡ç³»çµ±åŠŸèƒ½è¡çª**
   - é›»æºéµé•·æŒ‰ç³»çµ±æœƒå½ˆå‡ºé›»æºé¸å–®
   - å»ºè­°ï¼šä½¿ç”¨ 2 ç§’ä»¥ä¸Šçš„é•·æŒ‰é–¾å€¼ï¼Œæˆ–é€šéå…¶ä»–æ–¹å¼ç¦ç”¨ç³»çµ±é•·æŒ‰é¸å–®

3. **é…ç½®ç”Ÿæ•ˆæ™‚æ©Ÿ**
   - ä¿å­˜å¾Œé…ç½®æœƒåœ¨ 1 ç§’å…§è‡ªå‹•åˆ·æ–°
   - è‹¥æœªç”Ÿæ•ˆå¯å˜—è©¦ï¼šæŒ‰ä¸€æ¬¡å…¶ä»–æŒ‰éµè§¸ç™¼ reloadï¼Œæˆ–é‡å•Ÿ system_server

### ğŸ›¡ï¸ å®‰å…¨å»ºè­°

- é¦–æ¬¡æ¸¬è©¦å»ºè­°é…ç½®éŸ³é‡éµï¼Œé¿å…å½±éŸ¿é›»æºéµåŸºæœ¬åŠŸèƒ½
- é¿å…é…ç½®æœƒè§¸ç™¼åŒä¸€æŒ‰éµçš„ Shell å‘½ä»¤ï¼ˆå¦‚ `input keyevent 26`ï¼‰ï¼Œæœƒå°è‡´éæ­¸
- æ¸¬è©¦å‰å‚™ä»½é‡è¦æ•¸æ“š

### ğŸ” èª¿è©¦

```bash
# æŸ¥çœ‹æ¨¡çµ„æ—¥èªŒ
adb logcat | grep PowerKeyRules

# æŸ¥çœ‹é…ç½®æ–‡ä»¶ï¼ˆéœ€ rootï¼‰
adb shell su -c "cat /data/user/0/com.keymapping.powerkeyrules/shared_prefs/powerkey_rules.xml"

# æŸ¥çœ‹å‚™ä»½æ–‡ä»¶
adb shell su -c "cat /data/user_de/0/com.keymapping.powerkeyrules/files/rules.json"
```

---

## æ•…éšœæ’é™¤

### æ¨¡çµ„ä¸ç”Ÿæ•ˆ

1. æª¢æŸ¥ LSPosed Manager ä¸­æ¨¡çµ„æ˜¯å¦å•Ÿç”¨
2. ç¢ºèªå·²å‹¾é¸ã€Œç³»çµ±æ¡†æ¶ (android)ã€ä½œç”¨åŸŸ
3. é‡å•Ÿè¨­å‚™å¾ŒæŸ¥çœ‹æ—¥èªŒ: `adb logcat | grep PowerKeyRules`
4. ç¢ºèª LSPosed è‡ªèº«å·¥ä½œæ­£å¸¸ï¼ˆæª¢æŸ¥å…¶ä»–æ¨¡çµ„ï¼‰

### æŒ‰éµç„¡éŸ¿æ‡‰

1. æª¢æŸ¥ WebUI ä¿å­˜æ™‚æ˜¯å¦é¡¯ç¤ºã€Œå·²ä¿å­˜é…ç½®ã€
2. ç¢ºèª JSON æ ¼å¼æ­£ç¢ºï¼ˆWebUI æœƒè‡ªå‹•é©—è­‰ï¼‰
3. æŸ¥çœ‹æ—¥èªŒä¸­æ˜¯å¦æœ‰ "Rules loaded from service" æˆ–éŒ¯èª¤è¨Šæ¯
4. å˜—è©¦é‡å•Ÿ system_server: `adb shell su -c "killall system_server"`ï¼ˆæœƒé‡å•Ÿ UIï¼‰

### ç³»çµ±å¡é “/é‡å•Ÿ

1. ç«‹å³æª¢æŸ¥æ˜¯å¦é…ç½®äº†éæ­¸è¦å‰‡ï¼ˆå¦‚é›»æºéµè§¸ç™¼ `input keyevent 26`ï¼‰
2. é€šé ADB åˆªé™¤é…ç½®: `adb shell su -c "rm /data/user/0/com.keymapping.powerkeyrules/shared_prefs/powerkey_rules.xml"`
3. é‡å•Ÿè¨­å‚™ï¼Œåœ¨ LSPosed ä¸­æš«æ™‚åœç”¨æ¨¡çµ„
4. æª¢æŸ¥æ—¥èªŒæ‰¾å‡ºå•é¡Œè¦å‰‡

---

## é–‹ç™¼æŠ€è¡“æ£§

- **èªè¨€**: Kotlin 1.9.22
- **æ§‹å»º**: Gradle 8.2.1 + AGP 8.2.2
- **æœ€ä½ç‰ˆæœ¬**: Android 8.0 (API 26)
- **ç›®æ¨™ç‰ˆæœ¬**: Android 14 (API 34)
- **Xposed API**: Modern API v29 (`io.github.libxposed:api`)
- **LSPosed è¦æ±‚**: 1.9.1+

---

## è¨±å¯è­‰

æœ¬å°ˆæ¡ˆæ¡ç”¨ **Apache License 2.0** é–‹æºã€‚

---

## è²¢ç»

æ­¡è¿æäº¤ Issue å’Œ Pull Requestï¼

### é–‹ç™¼æŒ‡å—

1. `webui/` ç›®éŒ„ç‚ºé–‹ç™¼ç‰ˆæœ¬ï¼Œä¿®æ”¹å¾Œéœ€åŒæ­¥åˆ° `app/src/main/assets/webui/`
2. æ¸¬è©¦å‰å»ºè­°å…ˆåœ¨æ¨¡æ“¬å™¨/å‰¯è¨­å‚™é©—è­‰ï¼Œé¿å…å½±éŸ¿ä¸»è¨­å‚™
3. ä½¿ç”¨ Remote Preferences é€²è¡Œè·¨é€²ç¨‹é…ç½®å…±äº«ï¼ˆç„¡éœ€ AIDLï¼‰

#### WebUI - Single Source of Truth

- **å–®ä¸€ä¾†æº**ï¼š`webui/`ï¼ˆå°ˆæ¡ˆæ ¹ç›®éŒ„ï¼‰ç‚ºå”¯ä¸€çš„é–‹ç™¼èˆ‡ç¶­è­·ä½ç½®ï¼Œè«‹åœ¨è©²è³‡æ–™å¤¾ç·¨è¼¯æ‰€æœ‰å‰ç«¯æª”æ¡ˆã€‚
- **è‡ªå‹•åŒæ­¥**ï¼šåœ¨ `app/build.gradle` å·²æ–°å¢ Gradle ä»»å‹™ `syncWebUiAssets`ï¼ˆtype: `Copy`ï¼‰ï¼Œæœƒåœ¨ `preBuild` éšæ®µè‡ªå‹•å°‡ `webui/` çš„å…§å®¹è¤‡è£½åˆ° `app/src/main/assets/webui/`ï¼Œä»¥ä¾¿ APK æ‰“åŒ…æ™‚åŒ…å«æœ€æ–°è³‡æºã€‚
- **ä¸è¦ç›´æ¥ç·¨è¼¯ APK assets**ï¼šè«‹å‹¿åœ¨ `app/src/main/assets/webui/` ç›´æ¥ä¿®æ”¹æˆ–æäº¤æª”æ¡ˆï¼Œè©²è³‡æ–™å¤¾ç‚ºç·¨è­¯æ™‚ç”¢ç‰©ï¼Œæ‰‹å‹•ä¿®æ”¹æœƒè¢«è¦†è“‹ä¸”æ˜“é€ æˆä¸åŒæ­¥ã€‚
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šå°ˆæ¡ˆå·²å°‡ `app/src/main/assets/webui/` åŠ å…¥ `.gitignore`ï¼Œä»¥é¿å…æ„å¤–æäº¤ã€‚è‹¥éœ€æª¢è¦–æˆ–è‡¨æ™‚èª¿è©¦ï¼Œè«‹å¾ `webui/` ä¿®æ”¹ä¸¦é‡æ–°ç·¨è­¯ã€‚

å¦‚æœä½ ç™¼ç¾ `app/src/main/assets/webui/` ä¸­ä»æœ‰æª”æ¡ˆï¼Œä»£è¡¨å°šæœªåŸ·è¡Œè‡ªå‹•åŒæ­¥æˆ–è©²è³‡æ–™å¤¾è¢«éŒ¯èª¤æäº¤ï¼›è«‹åˆªé™¤å†—é¤˜æª”æ¡ˆä¸¦é€é Gradle æ§‹å»ºä¾†ç”Ÿæˆæœ€æ–°è³‡æºã€‚

### ç›¸é—œè³‡æº

- [**Modern Xposed API æ–‡æª”**](https://libxposed.github.io/api/) - libxposed/api å®˜æ–¹æ–‡æª”
- [LSPosed é …ç›®](https://github.com/LSPosed/LSPosed) - æ¨è–¦çš„ Xposed æ¡†æ¶
- [libxposed/api GitHub](https://github.com/libxposed/api) - API åŸå§‹ç¢¼
- [Android KeyEvent åƒè€ƒ](https://developer.android.com/reference/android/view/KeyEvent)
